window.self!==window.top&&(mw.require("liveedit.css"),mw.liveEditSaveService={grammarlyFix:function(e){return mw.$("grammarly-btn",e).remove(),mw.$("grammarly-card",e).remove(),mw.$("g.gr_",e).each(function(){mw.$(this).replaceWith(this.innerHTML)}),mw.$("[data-gramm_id]",e).removeAttr("data-gramm_id"),mw.$("[data-gramm]",e).removeAttr("data-gramm"),mw.$("[data-gramm_id]",e).removeAttr("data-gramm_id"),mw.$("grammarly-card",e).remove(),mw.$("grammarly-inline-cards",e).remove(),mw.$("grammarly-popups",e).remove(),mw.$("grammarly-extension",e).remove(),e},saving:!1,coreSave:function(e){if(!e)return!1;$.each(e,function(){var a=mw.tools.parseHtml(this.html).body;mw.liveEditSaveService.grammarlyFix(a),mw.liveEditSaveService.animationsClearFix(a),this.html=a.innerHTML}),mw.liveEditSaveService.saving=!0,e=JSON.stringify(e),e=btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(r,i){return String.fromCharCode("0x"+i)})),e={data_base64:e};var t=mw.ajax({type:"POST",url:mw.settings.api_url+"save_edit",data:e,dataType:"json",success:function(a){a&&a.new_page_url&&!mw.liveEditSaveService.DraftSaving&&(window.mw.parent().askusertostay=!1,window.mw.askusertostay=!1,window.location.href=a.new_page_url)}});return t.always(function(){mw.liveEditSaveService.saving=!1}),t},parseContent:function(e){e=e||document.body;var t=mw.tools.parseHtml(e.innerHTML);mw.$(".element-current",t).removeClass("element-current"),mw.$(".element-active",t).removeClass("element-active"),mw.$(".disable-resize",t).removeClass("disable-resize"),mw.$(".mw-module-drag-clone",t).removeClass("mw-module-drag-clone"),mw.$(".ui-draggable",t).removeClass("ui-draggable"),mw.$(".ui-draggable-handle",t).removeClass("ui-draggable-handle"),mw.$(".mt-ready",t).removeClass("mt-ready"),mw.$(".mw-webkit-drag-hover-binded",t).removeClass("mw-webkit-drag-hover-binded"),mw.$(".module-cat-toggle-Modules",t).removeClass("module-cat-toggle-Modules"),mw.$(".mw-module-drag-clone",t).removeClass("mw-module-drag-clone"),mw.$("-module",t).removeClass("-module"),mw.$(".empty-element",t).remove(),mw.$(".empty-element",t).remove(),mw.$(".edit .ui-resizable-handle",t).remove(),mw.$("script",t).remove(),mw.tools.classNamespaceDelete("all","ui-",t,"starts"),mw.$("[contenteditable]",t).removeAttr("contenteditable");for(var a=t.querySelectorAll("[contenteditable]"),r=a.length,i=0;i<r;i++)a[i].removeAttribute("contenteditable");for(var a=t.querySelectorAll(".module"),r=a.length,i=0;i<r;i++)a[i].querySelector(".edit")===null&&(a[i].innerHTML="");return t},htmlAttrValidate:function(e){var t=[];return $.each(e,function(){var a=this.outerHTML;a=a.replace(/url\(&quot;/g,"url('"),a=a.replace(/jpg&quot;/g,"jpg'"),a=a.replace(/jpeg&quot;/g,"jpeg'"),a=a.replace(/png&quot;/g,"png'"),a=a.replace(/gif&quot;/g,"gif'"),t.push($(a)[0])}),t},cleanUnwantedTags:function(e){return mw.$(".mw-skip-and-remove,script",e).remove(),e},animationsClearFix:function(e){return mw.$('[class*="animate__"]').each(function(){mw.tools.classNamespaceDelete(this,"animate__")}),e},collectData:function(e){mw.$(e).each(function(){mw.$("meta",this).remove(),$(".mw-le-spacer",this).empty().removeAttr("data-resizable").removeAttr("style")}),e=this.htmlAttrValidate(e);var t=e.length,a=0,r={},i={};if(t>0)for(;a<t;a++){r.item=e[a];var m=mw.tools.mwattr(r.item,"rel");m||(mw.$(r.item).removeClass("changed"),mw.tools.foreachParents(r.item,function(c){var w=this.className,p=mw.tools.mwattr(this,"rel");mw.tools.hasClass(w,"edit")&&mw.tools.hasClass(w,"changed")&&p&&(r.item=this,mw.tools.stopLoop(c))}));var m=mw.tools.mwattr(r.item,"rel");if(!m){var d=r.item.id?"#"+r.item.id:"";console.warn("Skipped save: .edit"+d+" element does not have rel attribute.");continue}mw.$(r.item).removeClass("changed orig_changed"),mw.$(r.item).removeClass("module-over"),mw.$(".module-over",r.item).each(function(){mw.$(this).removeClass("module-over")}),mw.$("[class]",r.item).each(function(){var c=this.getAttribute("class");typeof c=="string"&&(c=c.trim()),c||this.removeAttribute("class")});var s=mw.liveEditSaveService.cleanUnwantedTags(r.item).innerHTML,o={},n=r.item.attributes;if(n.length>0)for(var l=0,v=n.length;l<v;l++)o[n[l].nodeName]=n[l].nodeValue;var u={attributes:o,html:s},f="field_data_"+a;i[f]=u}return i},getData:function(e){var t=mw.liveEditSaveService.parseContent(e).body,a=t.querySelectorAll(".edit.changed");return mw.liveEditSaveService.collectData(a)},saveDisabled:!1,draftDisabled:!1,save:function(e,t,a){if(mw.trigger("beforeSaveStart",e),mw.top().app&&mw.top().app&&mw.top().app.cssEditor&&mw.top().app.cssEditor.publishIfChanged(),mw.liveEditSaveService.saveDisabled)return!1;if(!e){var r=mw.liveEditSaveService.parseContent().body,i=r.querySelectorAll(".edit.changed");e=mw.liveEditSaveService.collectData(i)}var m=(mw.__pageAnimations||[]).filter(function(o){return o.animation!=="none"});if(m&&m.length>0){var d={group:"template",key:"animations-global",value:JSON.stringify(m)};mw.options.saveOption(d)}if(mw.tools.isEmptyObject(e))return t&&t.call({}),!1;mw._liveeditData=e,mw.trigger("saveStart",mw._liveeditData);var s=mw.liveEditSaveService.coreSave(mw._liveeditData);return s.error(function(o){s.status==403&&(mw.dialog({id:"save_content_error_iframe_modal",html:"<iframe id='save_content_error_iframe' style='overflow-x:hidden;overflow-y:auto;' class='mw-modal-frame' ></iframe>",width:$(window).width()-90,height:$(window).height()-90}),mw.askusertostay=!1,mw.$("#save_content_error_iframe").ready(function(){var n=document.getElementById("save_content_error_iframe").contentWindow.document;n.open(),n.write(s.responseText),n.close();var l=0;n=document.getElementById("save_content_error_iframe").contentWindow.document,mw.$("#save_content_error_iframe").load(function(){var v=mw.$(".challenge-form",n).length;l++,v&&l==2&&setTimeout(function(){mw.askusertostay=!1,mw.$("#save_content_error_iframe_modal").remove()},150)})})),a&&a.call(o)}),s.success(function(o){mw.$(".edit.changed").removeClass("changed"),mw.$(".orig_changed").removeClass("orig_changed"),document.querySelector(".edit.changed")!==null?mw.liveEditSaveService.save():(mw.askusertostay=!1,mw.trigger("saveEnd",o)),t&&t.call(o)}),s.fail(function(o,n,l){mw.trigger("saveFailed",n,l),a&&a.call(sdata)}),s}},addEventListener("load",()=>{const e=async()=>new Promise(t=>{mw.liveEditSaveService.save(void 0,()=>t(!0),()=>t(!1))});mw.top().app.save=async()=>await e(),window.addEventListener("keydown",function(t){mw.top().app.canvas.dispatch("iframeKeyDown",{event:t})})}),self.onbeforeunload=function(e){mw.top().app.canvas.dispatch("liveEditCanvasBeforeUnload");var t=mw.top().app.canvas.getWindow();if(t&&t.mw&&t.mw.askusertostay)return!0;mw.top().spinner({element:mw.top().app.canvas.getFrame().parentElement,decorate:!0,size:52}).show()},mw.drag=mw.drag||{},mw.drag.save=function(){return mw.liveEditSaveService.save()},mw.drag.fix_placeholders=function(e,t){t=t||".edit .row";var a="div.col-md",r=mw.top().app.templateSettings.helperClasses.external_grids_col_classes,i;for(i=r.length-1;i>=0;--i)a+=",div."+r[i];mw.$(t).each(function(){var m=mw.$(this);m.children(a).each(function(){var d=mw.$(this).children("*");if(d.size()==0){mw.$(this).append('<div class="element" id="mw-element-'+mw.random()+'"></div>');var d=mw.$(this).children("div.element")}})})},mw.drag.module_settings=function(){var e=mw.top().app.liveEdit.moduleHandle.getTarget();return mw.top().app.editor.dispatch("onModuleSettingsRequest",e)},document.addEventListener("keydown",function(e){if(e.ctrlKey&&e.key==="s")return mw.top().app.editor.dispatch("Ctrl+S",e)}));self===top&&window.addEventListener("load",e=>{if(window.mwLiveEditIframeBackUrl){var t=document.createElement("a");t.id="back-to-live-sticky-button",t.textContent="Live Edit",t.href=window.mwLiveEditIframeBackUrl,t.classList.add("sticky"),document.body.appendChild(t),t.classList.add("sticky");var a=document.createElement("style");a.textContent=`
                #back-to-live-sticky-button {
                    position: absolute;
                    left: 50%;
                    transform: translateX(-50%);
                    z-index: 999;
                    transition: top 0.3s;
                    background: #000;
                    padding: 10px 20px;
                    border-radius: 5px;
                    border-top-left-radius: 0;
                    border-top-right-radius: 0;
                }
                 a#back-to-live-sticky-button {
                 color: #fff;
                 }
                #back-to-live-sticky-button.sticky {
                    top: 0;
                }
            `,document.head.appendChild(a)}});
